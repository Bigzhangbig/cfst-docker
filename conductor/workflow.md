# 项目工作流

## 指导原则

1.  **计划是事实的唯一来源：** 所有工作都必须在 `plan.md` 中进行跟踪
2.  **技术栈是经过深思熟虑的：** 对技术栈的更改必须在实施*前*记录在 `tech-stack.md` 中
3.  **测试驱动开发：** 在实现功能之前编写单元测试
4.  **高代码覆盖率：** 所有模块的目标代码覆盖率 >80%
5.  **用户体验至上：** 每个决策都应优先考虑用户体验
6.  **非交互式和 CI 感知：** 优先选择非交互式命令。对观察模式工具（测试、linter）使用 `CI=true` 以确保单次执行。

## 任务工作流

所有任务都遵循严格的生命周期：

### 标准任务工作流

1.  **选择任务：** 按顺序从 `plan.md` 中选择下一个可用任务

2.  **标记为进行中：** 在开始工作之前，编辑 `plan.md` 并将任务从 `[ ]` 更改为 `[~]`

3.  **编写失败的测试（红色阶段）：**
    -   为功能或错误修复创建一个新的测试文件。
    -   编写一个或多个单元测试，清楚地定义任务的预期行为和验收标准。
    -   **关键：** 运行测试并确认它们如预期那样失败。这是 TDD 的“红色”阶段。在有失败的测试之前，不要继续。

4.  **实施以通过测试（绿色阶段）：**
    -   编写最少量的应用程序代码，以使失败的测试通过。
    -   再次运行测试套件并确认所有测试现在都通过。这是“绿色”阶段。

5.  **重构（可选但推荐）：**
    -   在通过测试的保障下，重构实现代码和测试代码，以提高清晰度、消除重复并增强性能，而不改变外部行为。
    -   重新运行测试以确保它们在重构后仍然通过。

6.  **验证覆盖率：** 使用项目选择的工具运行覆盖率报告。例如，在 Python 项目中，这可能如下所示：
    ```bash
    pytest --cov=app --cov-report=html
    ```
    目标：新代码的覆盖率 >80%。具体的工具和命令将因语言和框架而异。

7.  **记录偏差：** 如果实现与技术栈不同：
    -   **停止**实施
    -   使用新设计更新 `tech-stack.md`
    -   添加注明日期的注释以解释更改
    -   恢复实施

8.  **提交代码更改：**
    -   暂存与任务相关的所有代码更改。
    -   提出一个清晰、简洁的提交消息，例如 `feat(ui): 为计算器创建基本的 HTML 结构`。
    -   执行提交。

9.  **使用 Git Notes 附加任务摘要：**
    -   **步骤 9.1：获取提交哈希：** 获取*刚刚完成的提交*的哈希 (`git log -1 --format="%H"`)。
    -   **步骤 9.2：草拟笔记内容：** 为已完成的任务创建详细摘要。这应包括任务名称、更改摘要、所有创建/修改文件的列表以及更改的核心“原因”。
    -   **步骤 9.3：附加笔记：** 使用 `git notes` 命令将摘要附加到提交。
        ```bash
        # 上一步的笔记内容通过 -m 标志传递。
        git notes add -m "<笔记内容>" <提交哈希>
        ```

10. **获取并记录任务提交 SHA：**
    -   **步骤 10.1：更新计划：** 读取 `plan.md`，找到已完成任务的行，将其状态从 `[~]` 更新为 `[x]`，并附加*刚刚完成的提交*的提交哈希的前 7 个字符。
    -   **步骤 10.2：编写计划：** 将更新后的内容写回 `plan.md`。

11. **提交计划更新：**
    -   **操作：** 暂存修改后的 `plan.md` 文件。
    -   **操作：** 使用描述性消息（例如 `conductor(plan): 将任务“创建用户模型”标记为完成`）提交此更改。

### 阶段完成验证和检查点协议

**触发器：** 此协议在任务完成并结束 `plan.md` 中的一个阶段后立即执行。

1.  **宣布协议开始：** 通知用户该阶段已完成，并且验证和检查点协议已开始。

2.  **确保阶段更改的测试覆盖率：**
    -   **步骤 2.1：确定阶段范围：** 要识别此阶段中更改的文件，您必须首先找到起点。读取 `plan.md` 以查找*上一个*阶段检查点的 Git 提交 SHA。如果不存在上一个检查点，则范围是自第一次提交以来的所有更改。
    -   **步骤 2.2：列出更改的文件：** 执行 `git diff --name-only <上一个检查点 sha> HEAD` 以获取此阶段期间修改的所有文件的精确列表。
    -   **步骤 2.3：验证和创建测试：** 对于列表中的每个文件：
        -   **关键：** 首先，检查其扩展名。排除非代码文件（例如 `.json`、`.md`、`.yaml`）。
        -   对于每个剩余的代码文件，验证是否存在相应的测试文件。
        -   如果缺少测试文件，您**必须**创建一个。在编写测试之前，**首先，分析存储库中的其他测试文件以确定正确的命名约定和测试风格。**新测试**必须**验证此阶段任务（`plan.md`）中描述的功能。

3.  **执行带有主动调试的自动化测试：**
    -   在执行之前，您**必须**宣布您将用于运行测试的确切 shell 命令。
    -   **示例公告：** “我现在将运行自动化测试套件以验证该阶段。**命令：** `CI=true npm test`”
    -   执行宣布的命令。
    -   如果测试失败，您**必须**通知用户并开始调试。您最多可以尝试提出两次修复建议。如果在您第二次提出的修复后测试仍然失败，您**必须停止**，报告持续的失败，并请求用户指导。

4.  **提出详细、可操作的手动验证计划：**
    -   **关键：** 要生成计划，首先分析 `product.md`、`product-guidelines.md` 和 `plan.md` 以确定已完成阶段面向用户的目标。
    -   您**必须**生成一个分步计划，引导用户完成验证过程，包括任何必要的命令和具体的预期结果。
    -   您呈现给用户的计划**必须**遵循此格式：

        **对于前端更改：**
        ```
        自动化测试已通过。对于手动验证，请按照以下步骤操作：

        **手动验证步骤：**
        1.  **使用以下命令启动开发服务器：** `npm run dev`
        2.  **在浏览器中打开：** `http://localhost:3000`
        3.  **确认您看到：** 新的用户个人资料页面，正确显示用户名和电子邮件。
        ```

        **对于后端更改：**
        ```
        自动化测试已通过。对于手动验证，请按照以下步骤操作：

        **手动验证步骤：**
        1.  **确保服务器正在运行。**
        2.  **在终端中执行以下命令：** `curl -X POST http://localhost:8080/api/v1/users -d '{"name": "test"}'`
        3.  **确认您收到：** 状态为 `201 Created` 的 JSON 响应。
        ```

5.  **等待明确的用户反馈：**
    -   在提出详细计划后，向用户请求确认：“**这符合您的期望吗？请用“是”确认或提供需要更改的反馈。**”
    -   **暂停**并等待用户的响应。没有明确的“是”或确认，不要继续。

6.  **创建检查点提交：**
    -   暂存所有更改。如果此步骤中没有发生任何更改，请继续执行空提交。
    -   使用清晰简洁的消息执行提交（例如，`conductor(checkpoint): 检查点阶段 X 结束`）。

7.  **使用 Git Notes 附加可审计的验证报告：**
    -   **步骤 7.1：草拟笔记内容：** 创建一个详细的验证报告，包括自动化测试命令、手动验证步骤和用户的确认。
    -   **步骤 7.2：附加笔记：** 使用 `git notes` 命令和上一步的完整提交哈希将完整报告附加到检查点提交。

8.  **获取并记录阶段检查点 SHA：**
    -   **步骤 8.1：获取提交哈希：** 获取*刚刚创建的检查点提交*的哈希 (`git log -1 --format="%H"`)。
    -   **步骤 8.2：更新计划：** 读取 `plan.md`，找到已完成阶段的标题，并以 `[checkpoint: <sha>]` 的格式附加提交哈希的前 7 个字符。
    -   **步骤 8.3：编写计划：** 将更新后的内容写回 `plan.md`。

9. **提交计划更新：**
    -   **操作：** 暂存修改后的 `plan.md` 文件。
    -   **操作：** 使用遵循 `conductor(plan): 将阶段 '<阶段名称>' 标记为完成` 格式的描述性消息提交此更改。

10. **宣布完成：** 通知用户该阶段已完成并已创建检查点，详细的验证报告已作为 git note 附加。

### 质量门

在将任何任务标记为完成之前，请验证：

- [ ] 所有测试通过
- [ ] 代码覆盖率满足要求 (>80%)
- [ ] 代码遵循项目的代码风格指南 (如 `code_styleguides/` 中所定义)
- [ ] 所有公共函数/方法都有文档 (例如，docstrings、JSDoc、GoDoc)
- [ ] 强制执行类型安全 (例如，类型提示、TypeScript 类型、Go 类型)
- [ ] 没有 linting 或静态分析错误 (使用项目配置的工具)
- [ ] 在移动设备上正常工作 (如果适用)
- [ ] 如果需要，更新文档
- [ ] 未引入安全漏洞

## 开发命令

**AI 代理指令：本节应根据项目的特定语言、框架和构建工具进行调整。**

### 设置
```bash
# 示例：设置开发环境的命令 (例如，安装依赖项、配置数据库)
# 例如，对于 Node.js 项目： npm install
# 例如，对于 Go 项目： go mod tidy
```

### 日常开发
```bash
# 示例：用于日常常见任务的命令 (例如，启动开发服务器、运行测试、lint、格式化)
# 例如，对于 Node.js 项目： npm run dev, npm test, npm run lint
# 例如，对于 Go 项目： go run main.go, go test ./..., go fmt ./...
```

### 提交前
```bash
# 示例：运行所有提交前检查的命令 (例如，格式化、lint、类型检查、运行测试)
# 例如，对于 Node.js 项目： npm run check
# 例如，对于 Go 项目： make check (如果存在 Makefile)
```

## 测试要求

### 单元测试
- 每个模块都必须有相应的测试。
- 使用适当的测试设置/拆卸机制 (例如，fixtures、beforeEach/afterEach)。
- 模拟外部依赖项。
- 测试成功和失败的情况。

### 集成测试
- 测试完整的用户流程
- 验证数据库事务
- 测试身份验证和授权
- 检查表单提交

### 移动测试
- 尽可能在实际 iPhone 上测试
- 使用 Safari 开发人员工具
- 测试触摸交互
- 验证响应式布局
- 检查 3G/4G 上的性能

## 代码审查流程

### 自我审查清单
在请求审查之前：

1. **功能性**
   - 功能按规定工作
   - 处理了边缘情况
   - 错误消息对用户友好

2. **代码质量**
   - 遵循风格指南
   - 应用了 DRY 原则
   - 清晰的变量/函数名称
   - 适当的注释

3. **测试**
   - 单元测试全面
   - 集成测试通过
   - 覆盖率足够 (>80%)

4. **安全性**
   - 没有硬编码的秘密
   - 存在输入验证
   - 防止了 SQL 注入
   - 实施了 XSS 保护

5. **性能**
   - 优化了数据库查询
   - 优化了图像
   - 在需要时实施了缓存

6. **移动体验**
   - 触摸目标足够大 (44x44px)
   - 无需缩放即可阅读文本
   - 在移动设备上性能可接受
   - 交互感觉原生

## 提交指南

### 消息格式
```
<类型>(<范围>): <描述>

[可选正文]

[可选页脚]
```

### 类型
- `feat`: 新功能
- `fix`: 错误修复
- `docs`: 仅文档
- `style`: 格式化、缺少分号等。
- `refactor`: 既不修复错误也不添加功能的代码更改
- `test`: 添加缺失的测试
- `chore`: 维护任务

### 示例
```bash
git commit -m "feat(auth): 添加“记住我”功能"
git commit -m "fix(posts): 纠正短文的摘要生成"
git commit -m "test(comments): 为表情符号反应限制添加测试"
git commit -m "style(mobile): 改进按钮触摸目标"
```

## 完成的定义

任务完成的条件是：

1. 所有代码均按规范实现
2. 单元测试已编写并通过
3. 代码覆盖率满足项目要求
4. 文档完整 (如果适用)
5. 代码通过所有配置的 linting 和静态分析检查
6. 在移动设备上完美运行 (如果适用)
7. 实施说明已添加到 `plan.md`
8. 使用正确的消​​息提交了更改
9. 带有任务摘要的 Git note 附加到提交

## 紧急程序

### 生产中的严重错误
1. 从 main 创建 hotfix 分支
2. 为错误编写失败的测试
3. 实施最小修复
4. 全面测试，包括移动端
5. 立即部署
6. 在 plan.md 中记录

### 数据丢失
1. 停止所有写操作
2. 从最新备份还原
3. 验证数据完整性
4. 记录事件
5. 更新备份程序

### 安全漏洞
1. 立即轮换所有秘密
2.审查访问日志
3. 修补漏洞
4. 通知受影响的用户 (如果有)
5. 记录并更新安全程序

## 部署工作流

### 部署前清单
- [ ] 所有测试通过
- [ ] 覆盖率 >80%
- [ ] 没有 linting 错误
- [ ] 移动测试完成
- [ ] 环境变量已配置
- [ ] 数据库迁移已准备就绪
- [ ] 已创建备份

### 部署步骤
1. 将功能分支合并到 main
2. 使用版本标记发布
3. 推送到部署服务
4. 运行数据库迁移
5. 验证部署
6. 测试关键路径
7. 监控错误

### 部署后
1. 监控分析
2. 检查错误日志
3. 收集用户反馈
4. 计划下一次迭代

## 持续改进

- 每周审查工作流程
- 根据痛点进行更新
- 记录经验教训
- 优化用户幸福感
- 保持简单和可维护