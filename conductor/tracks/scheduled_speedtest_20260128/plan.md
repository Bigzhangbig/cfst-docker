# 实施计划 - 添加定时测速功能

本计划遵循 TDD（测试驱动开发）流程，旨在为容器添加循环和 Cron 定时模式。

## 阶段 1：核心逻辑重构与多模式分发
- [ ] 任务：重构 `entrypoint.sh`，将测速主逻辑封装为可调用函数。
    - [ ] 编写测试脚本验证主函数在被外部调用时的正确性。
    - [ ] 提取现有的单次运行逻辑到 `run_speedtest` 函数。
- [ ] 任务：实现运行模式自动分发逻辑。
    - [ ] 编写测试验证不同环境变量组合（CRON/LOOP/None）下的分发行为。
    - [ ] 在 `entrypoint.sh` 中添加条件判断，识别 `CRON` 和 `LOOP_INTERVAL`。
- [ ] 任务：Conductor - 用户手动验证 '阶段 1：核心逻辑重构与多模式分发' (协议在 workflow.md 中)

## 阶段 2：循环模式 (Loop) 与日志管理
- [ ] 任务：实现基于 `LOOP_INTERVAL` 的循环运行逻辑。
    - [ ] 编写测试模拟循环运行并验证间隔时间。
    - [ ] 在 `entrypoint.sh` 中实现 `while sleep` 逻辑。
- [ ] 任务：实现简单的日志轮转（Log Rotation）。
    - [ ] 编写测试验证 `speedtest.log` 在多次运行后的大小限制。
    - [ ] 在每次测速前后执行日志截断逻辑（如保留最后 1000 行）。
- [ ] 任务：Conductor - 用户手动验证 '阶段 2：循环模式 (Loop) 与日志管理' (协议在 workflow.md 中)

## 阶段 3：定时模式 (Cron) 实现
- [ ] 任务：集成 BusyBox `crond` 并生成 crontab。
    - [ ] 编写测试验证产生的 crontab 文件格式是否正确。
    - [ ] 实现根据 `CRON` 变量动态生成并加载 crontab 任务。
- [ ] 任务：优化 `Dockerfile` 以支持长期运行模式。
    - [ ] 添加 `HEALTHCHECK` 指令，通过检查主进程存活状态来判断健康度。
- [ ] 任务：Conductor - 用户手动验证 '阶段 3：定时模式 (Cron) 实现' (协议在 workflow.md 中)

## 阶段 4：综合验证与文档更新
- [ ] 任务：更新 E2E 测试脚本以覆盖定时/循环场景。
    - [ ] 在测试环境中短时间运行循环模式并验证结果生成。
- [ ] 任务：更新 `README.md`，记录新的环境变量和使用示例。
- [ ] 任务：Conductor - 用户手动验证 '阶段 4：综合验证与文档更新' (协议在 workflow.md 中)
